{"version":3,"file":"babel-transform.js","names":["collector","babel","options","cache","TransformCacheCollection","name","pre","file","debug","opts","filename","entryPoint","code","only","prepareStageResults","prepareForEvalSync","syncResolve","root","undefined","pluginOptions","every","r","withLinariaMetadata","metadata","evalStageResult","evalStage","map","valueCache","path","traverse","Identifier","p","processTemplateExpression","processor","build","doRuntimeReplacement","prevalExport","scope","getData","findParent","isExpressionStatement","removeWithRelated","visitor","post"],"sources":["../../src/plugins/babel-transform.ts"],"sourcesContent":["import type { BabelFile, PluginObj } from '@babel/core';\nimport type { NodePath } from '@babel/traverse';\n\nimport { debug } from '@linaria/logger';\nimport type { StrictOptions } from '@linaria/utils';\nimport { removeWithRelated, syncResolve } from '@linaria/utils';\n\nimport type { Core } from '../babel';\nimport { TransformCacheCollection } from '../cache';\nimport { prepareForEvalSync } from '../transform-stages/1-prepare-for-eval';\nimport evalStage from '../transform-stages/2-eval';\nimport type { IPluginState } from '../types';\nimport processTemplateExpression from '../utils/processTemplateExpression';\nimport withLinariaMetadata from '../utils/withLinariaMetadata';\n\nexport default function collector(\n  babel: Core,\n  options: StrictOptions\n): PluginObj<IPluginState> {\n  const cache = new TransformCacheCollection();\n\n  return {\n    name: '@linaria/babel/babel-transform',\n    pre(file: BabelFile) {\n      debug('babel-transform:start', file.opts.filename);\n\n      const entryPoint = {\n        name: file.opts.filename!,\n        code: file.code,\n        only: ['__linariaPreval'],\n      };\n\n      const prepareStageResults = prepareForEvalSync(\n        babel,\n        cache,\n        syncResolve,\n        entryPoint,\n        {\n          root: file.opts.root ?? undefined,\n          pluginOptions: options,\n        }\n      );\n\n      if (\n        !prepareStageResults ||\n        prepareStageResults.every((r) => !withLinariaMetadata(r.metadata))\n      ) {\n        return;\n      }\n\n      const evalStageResult = evalStage(\n        cache,\n        prepareStageResults.map((r) => r.code),\n        {\n          filename: file.opts.filename!,\n          pluginOptions: options,\n        }\n      );\n\n      if (evalStageResult === null) {\n        return;\n      }\n\n      const [valueCache] = evalStageResult;\n\n      file.path.traverse({\n        // TODO: process transformed literals\n        Identifier: (p) => {\n          processTemplateExpression(p, file.opts, options, (processor) => {\n            processor.build(valueCache);\n\n            processor.doRuntimeReplacement();\n          });\n        },\n      });\n\n      // We can remove __linariaPreval export and all related code\n      const prevalExport = (\n        file.path.scope.getData('__linariaPreval') as NodePath | undefined\n      )?.findParent((p) => p.isExpressionStatement());\n      if (prevalExport) {\n        removeWithRelated([prevalExport]);\n      }\n    },\n    visitor: {},\n    post(file: BabelFile) {\n      debug('babel-transform:end', file.opts.filename);\n    },\n  };\n}\n"],"mappings":";;;;;;AAGA;AAEA;AAGA;AACA;AACA;AAEA;AACA;AAA+D;AAEhD,SAASA,SAAS,CAC/BC,KAAW,EACXC,OAAsB,EACG;EACzB,MAAMC,KAAK,GAAG,IAAIC,+BAAwB,EAAE;EAE5C,OAAO;IACLC,IAAI,EAAE,gCAAgC;IACtCC,GAAG,CAACC,IAAe,EAAE;MAAA;MACnB,IAAAC,aAAK,EAAC,uBAAuB,EAAED,IAAI,CAACE,IAAI,CAACC,QAAQ,CAAC;MAElD,MAAMC,UAAU,GAAG;QACjBN,IAAI,EAAEE,IAAI,CAACE,IAAI,CAACC,QAAS;QACzBE,IAAI,EAAEL,IAAI,CAACK,IAAI;QACfC,IAAI,EAAE,CAAC,iBAAiB;MAC1B,CAAC;MAED,MAAMC,mBAAmB,GAAG,IAAAC,kCAAkB,EAC5Cd,KAAK,EACLE,KAAK,EACLa,kBAAW,EACXL,UAAU,EACV;QACEM,IAAI,qBAAEV,IAAI,CAACE,IAAI,CAACQ,IAAI,6DAAIC,SAAS;QACjCC,aAAa,EAAEjB;MACjB,CAAC,CACF;MAED,IACE,CAACY,mBAAmB,IACpBA,mBAAmB,CAACM,KAAK,CAAEC,CAAC,IAAK,CAAC,IAAAC,4BAAmB,EAACD,CAAC,CAACE,QAAQ,CAAC,CAAC,EAClE;QACA;MACF;MAEA,MAAMC,eAAe,GAAG,IAAAC,aAAS,EAC/BtB,KAAK,EACLW,mBAAmB,CAACY,GAAG,CAAEL,CAAC,IAAKA,CAAC,CAACT,IAAI,CAAC,EACtC;QACEF,QAAQ,EAAEH,IAAI,CAACE,IAAI,CAACC,QAAS;QAC7BS,aAAa,EAAEjB;MACjB,CAAC,CACF;MAED,IAAIsB,eAAe,KAAK,IAAI,EAAE;QAC5B;MACF;MAEA,MAAM,CAACG,UAAU,CAAC,GAAGH,eAAe;MAEpCjB,IAAI,CAACqB,IAAI,CAACC,QAAQ,CAAC;QACjB;QACAC,UAAU,EAAGC,CAAC,IAAK;UACjB,IAAAC,kCAAyB,EAACD,CAAC,EAAExB,IAAI,CAACE,IAAI,EAAEP,OAAO,EAAG+B,SAAS,IAAK;YAC9DA,SAAS,CAACC,KAAK,CAACP,UAAU,CAAC;YAE3BM,SAAS,CAACE,oBAAoB,EAAE;UAClC,CAAC,CAAC;QACJ;MACF,CAAC,CAAC;;MAEF;MACA,MAAMC,YAAY,4BAChB7B,IAAI,CAACqB,IAAI,CAACS,KAAK,CAACC,OAAO,CAAC,iBAAiB,CAAC,0DADvB,sBAElBC,UAAU,CAAER,CAAC,IAAKA,CAAC,CAACS,qBAAqB,EAAE,CAAC;MAC/C,IAAIJ,YAAY,EAAE;QAChB,IAAAK,wBAAiB,EAAC,CAACL,YAAY,CAAC,CAAC;MACnC;IACF,CAAC;IACDM,OAAO,EAAE,CAAC,CAAC;IACXC,IAAI,CAACpC,IAAe,EAAE;MACpB,IAAAC,aAAK,EAAC,qBAAqB,EAAED,IAAI,CAACE,IAAI,CAACC,QAAQ,CAAC;IAClD;EACF,CAAC;AACH"}