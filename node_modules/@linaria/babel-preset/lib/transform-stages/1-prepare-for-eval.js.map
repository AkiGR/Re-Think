{"version":3,"file":"1-prepare-for-eval.js","names":["isModuleResolver","i","key","runPreevalStage","babel","filename","code","options","perFileBabelConfig","pluginOptions","loadLinariaOptions","parseConfig","buildOptions","babelOptions","fullParserOptions","loadBabelOptions","file","cachedParseSync","transformPlugins","require","resolve","moduleResolverPlugin","plugins","find","unshift","transformConfig","envName","sourceMaps","sourceFileName","inputSourceMap","root","ast","babelrc","configFile","result","transformFromAstSync","program","Error","getMatchedRule","rules","length","rule","test","RegExp","action","prepareCode","originalCode","only","fileCache","log","createCustomDebug","getFileIdx","set","preevalStageResult","withLinariaMetadata","metadata","evaluator","paths","dirname","default","name","processQueueItem","item","cache","undefined","codeCache","results","Set","has","Map","extension","extname","extensions","includes","join","uncachedExports","get","forEach","token","delete","add","size","imports","Array","from","remainExports","preparedCode","prepareForEvalSync","resolvedFile","stack","processed","queue","importsOnly","importedFile","resolved","resolveCache","fileContent","readFileSync","push","err","mutexes","prepareForEval","mutex","promises","promise","then","resolveCacheKey","cached","importsOnlySet","cachedOnly","split","Promise","all"],"sources":["../../src/transform-stages/1-prepare-for-eval.ts"],"sourcesContent":["import { readFileSync } from 'fs';\nimport { dirname, extname } from 'path';\n\nimport type { BabelFileResult, TransformOptions } from '@babel/core';\n\nimport { createCustomDebug } from '@linaria/logger';\nimport type { EvalRule, Evaluator } from '@linaria/utils';\nimport { buildOptions, getFileIdx, loadBabelOptions } from '@linaria/utils';\n\nimport type { Core } from '../babel';\nimport type { TransformCacheCollection } from '../cache';\nimport type Module from '../module';\nimport type { ITransformFileResult, Options } from '../types';\nimport withLinariaMetadata from '../utils/withLinariaMetadata';\n\nimport cachedParseSync from './helpers/cachedParseSync';\nimport loadLinariaOptions from './helpers/loadLinariaOptions';\n\nexport type FileInQueue = {\n  name: string;\n  code: string;\n  only: string[];\n} | null;\n\nconst isModuleResolver = (i: unknown): i is { options: unknown } =>\n  typeof i === 'object' &&\n  i !== null &&\n  (i as { key?: string }).key === 'module-resolver';\n\nfunction runPreevalStage(\n  babel: Core,\n  filename: string,\n  code: string,\n  options: Pick<Options, 'root' | 'pluginOptions' | 'inputSourceMap'>,\n  perFileBabelConfig?: TransformOptions\n): BabelFileResult {\n  const pluginOptions = loadLinariaOptions(options.pluginOptions);\n  const parseConfig = buildOptions(\n    pluginOptions?.babelOptions,\n    perFileBabelConfig\n  );\n\n  const fullParserOptions = loadBabelOptions(babel, filename, parseConfig);\n  const file = cachedParseSync(babel, code, fullParserOptions);\n\n  const transformPlugins: babel.PluginItem[] = [\n    [require.resolve('../plugins/preeval'), pluginOptions],\n  ];\n\n  const moduleResolverPlugin =\n    fullParserOptions.plugins?.find(isModuleResolver);\n  if (moduleResolverPlugin) {\n    transformPlugins.unshift(moduleResolverPlugin);\n  }\n\n  const transformConfig = buildOptions({\n    envName: 'linaria',\n    plugins: transformPlugins,\n    sourceMaps: true,\n    sourceFileName: filename,\n    inputSourceMap: options.inputSourceMap,\n    root: options.root,\n    ast: true,\n    babelrc: false,\n    configFile: false,\n  });\n\n  const result = babel.transformFromAstSync(file, code, {\n    ...transformConfig,\n    filename,\n  });\n\n  if (!result || !result.ast?.program) {\n    throw new Error('Babel transform failed');\n  }\n\n  return result;\n}\n\nfunction getMatchedRule(\n  rules: EvalRule[],\n  filename: string,\n  code: string\n): EvalRule {\n  for (let i = rules.length - 1; i >= 0; i--) {\n    const rule = rules[i];\n    if (!rule.test) {\n      return rule;\n    }\n\n    if (typeof rule.test === 'function' && rule.test(filename, code)) {\n      return rule;\n    }\n\n    if (rule.test instanceof RegExp && rule.test.test(filename)) {\n      return rule;\n    }\n  }\n\n  return { action: 'ignore' };\n}\n\nfunction prepareCode(\n  babel: Core,\n  filename: string,\n  originalCode: string,\n  only: string[],\n  options: Pick<Options, 'root' | 'pluginOptions' | 'inputSourceMap'>,\n  fileCache: Map<string | symbol, ITransformFileResult>\n): [\n  code: string,\n  imports: Module['imports'],\n  metadata?: babel.BabelFileMetadata\n] {\n  const log = createCustomDebug('transform', getFileIdx(filename));\n\n  const pluginOptions = loadLinariaOptions(options.pluginOptions);\n\n  const { action, babelOptions } = getMatchedRule(\n    pluginOptions.rules,\n    filename,\n    originalCode\n  );\n\n  if (action === 'ignore') {\n    log('stage-1:ignore', '');\n    fileCache.set('*', {\n      code: originalCode,\n    });\n\n    return [originalCode, null];\n  }\n\n  const preevalStageResult = runPreevalStage(\n    babel,\n    filename,\n    originalCode,\n    options,\n    babelOptions\n  );\n\n  if (\n    only.length === 1 &&\n    only[0] === '__linariaPreval' &&\n    !withLinariaMetadata(preevalStageResult.metadata)\n  ) {\n    log('stage-1:evaluator:end', 'no metadata');\n    return [preevalStageResult.code!, null, preevalStageResult.metadata];\n  }\n\n  log('stage-1:preeval', 'metadata %O', preevalStageResult.metadata);\n\n  // Action can be a function or a module name\n  const evaluator: Evaluator =\n    typeof action === 'function'\n      ? action\n      : require(require.resolve(action, {\n          paths: [dirname(filename)],\n        })).default;\n\n  log('stage-1:evaluator:start', 'using %s', evaluator.name);\n\n  const result = evaluator(\n    filename,\n    pluginOptions,\n    preevalStageResult.code!,\n    only,\n    babel\n  );\n\n  log('stage-1:evaluator:end', '');\n\n  return [...result, preevalStageResult.metadata];\n}\n\nfunction processQueueItem(\n  babel: Core,\n  item: {\n    name: string;\n    code: string;\n    only: string[];\n  } | null,\n  cache: TransformCacheCollection,\n  options: Pick<Options, 'root' | 'pluginOptions' | 'inputSourceMap'>\n):\n  | {\n      imports: Map<string, string[]> | null;\n      name: string;\n      results: ITransformFileResult[];\n    }\n  | undefined {\n  if (!item) {\n    return undefined;\n  }\n  const { codeCache } = cache;\n  const pluginOptions = loadLinariaOptions(options.pluginOptions);\n\n  const results = new Set<ITransformFileResult>();\n\n  const { name, only, code } = item;\n  if (!codeCache.has(name)) {\n    codeCache.set(name, new Map());\n  }\n\n  const log = createCustomDebug('transform', getFileIdx(name));\n\n  const extension = extname(name);\n  if (!pluginOptions.extensions.includes(extension)) {\n    log(\n      'init',\n      `${name} is ignored. If you want it to be processed, you should add '${extension}' to the \"extensions\" option.`\n    );\n    return undefined;\n  }\n\n  log('init', `${name} (${only.join(', ')})\\n${code}`);\n\n  const uncachedExports = new Set(only);\n  const fileCache = codeCache.get(name)!;\n  uncachedExports.forEach((token) => {\n    if (fileCache.has(token)) {\n      uncachedExports.delete(token);\n      results.add(fileCache.get(token)!);\n    }\n  });\n\n  if (uncachedExports.size === 0) {\n    // Already processed\n    return {\n      imports: null,\n      name,\n      results: Array.from(results),\n    };\n  }\n\n  const remainExports = Array.from(uncachedExports);\n\n  log('stage-1', `>> (${remainExports.join(', ')})`);\n\n  const [preparedCode, imports, metadata] = prepareCode(\n    babel,\n    name,\n    code,\n    remainExports,\n    options,\n    fileCache\n  );\n\n  if (code === preparedCode) {\n    log('stage-1', `<< (${remainExports.join(', ')})\\n === no changes ===`);\n  } else {\n    log('stage-1', `<< (${remainExports.join(', ')})\\n${preparedCode}`);\n  }\n\n  const result = {\n    metadata,\n    code: preparedCode,\n  };\n  results.add(result);\n\n  remainExports.forEach((token) => {\n    fileCache.set(token, result);\n  });\n\n  if (preparedCode === '') return undefined;\n\n  return {\n    imports,\n    name,\n    results: Array.from(results),\n  };\n}\n\nexport function prepareForEvalSync(\n  babel: Core,\n  cache: TransformCacheCollection,\n  resolve: (what: string, importer: string, stack: string[]) => string,\n  resolvedFile: FileInQueue,\n  options: Pick<Options, 'root' | 'pluginOptions' | 'inputSourceMap'>,\n  stack: string[] = []\n): ITransformFileResult[] | undefined {\n  const processed = processQueueItem(babel, resolvedFile, cache, options);\n  if (!processed) return undefined;\n\n  const { imports, name, results } = processed;\n\n  const log = createCustomDebug('transform', getFileIdx(name));\n\n  const queue: FileInQueue[] = [];\n\n  imports?.forEach((importsOnly, importedFile) => {\n    try {\n      const resolved = resolve(importedFile, name, stack);\n      log('stage-1:sync-resolve', `✅ ${importedFile} -> ${resolved}`);\n      cache.resolveCache.set(\n        `${name} -> ${importedFile}`,\n        `${resolved}\\0${importsOnly.join(',')}`\n      );\n      const fileContent = readFileSync(resolved, 'utf8');\n      queue.push({\n        name: resolved,\n        only: importsOnly,\n        code: fileContent,\n      });\n    } catch (err) {\n      log('stage-1:sync-resolve', `❌ cannot resolve ${importedFile}: %O`, err);\n    }\n  });\n\n  queue.forEach((item) => {\n    prepareForEvalSync(babel, cache, resolve, item, options, [name, ...stack]);\n  });\n\n  return Array.from(results);\n}\n\nconst mutexes = new Map<string, Promise<void>>();\n\n/**\n * Parses the specified file and recursively all its dependencies,\n * finds tags, applies eval-time replacements, removes dead code.\n */\nexport default async function prepareForEval(\n  babel: Core,\n  cache: TransformCacheCollection,\n  resolve: (\n    what: string,\n    importer: string,\n    stack: string[]\n  ) => Promise<string | null>,\n  file: Promise<FileInQueue>,\n  options: Pick<Options, 'root' | 'pluginOptions' | 'inputSourceMap'>,\n  stack: string[] = []\n): Promise<ITransformFileResult[] | undefined> {\n  const resolvedFile = await file;\n  const mutex = resolvedFile ? mutexes.get(resolvedFile.name) : null;\n  if (mutex) {\n    await mutex;\n  }\n\n  const processed = processQueueItem(babel, resolvedFile, cache, options);\n  if (!processed) return undefined;\n\n  const { imports, name, results } = processed;\n\n  const log = createCustomDebug('transform', getFileIdx(name));\n\n  const promises: Promise<ITransformFileResult[] | undefined>[] = [];\n\n  imports?.forEach((importsOnly, importedFile) => {\n    const promise = resolve(importedFile, name, stack).then(\n      (resolved) => {\n        if (resolved === null) {\n          log('stage-1:resolve', `✅ ${importedFile} is ignored`);\n          return null;\n        }\n\n        log('stage-1:async-resolve', `✅ ${importedFile} -> ${resolved}`);\n        const resolveCacheKey = `${name} -> ${importedFile}`;\n        const cached = cache.resolveCache.get(resolveCacheKey);\n        const importsOnlySet = new Set(importsOnly);\n        if (cached) {\n          const [, cachedOnly] = cached.split('\\0');\n          cachedOnly?.split(',').forEach((token) => {\n            importsOnlySet.add(token);\n          });\n        }\n\n        cache.resolveCache.set(\n          resolveCacheKey,\n          `${resolved}\\0${[...importsOnlySet].join(',')}`\n        );\n        const fileContent = readFileSync(resolved, 'utf8');\n        return {\n          name: resolved,\n          only: importsOnly,\n          code: fileContent,\n        };\n      },\n      (err: unknown) => {\n        log(\n          'stage-1:async-resolve',\n          `❌ cannot resolve ${importedFile}: %O`,\n          err\n        );\n        return null;\n      }\n    );\n\n    promises.push(\n      prepareForEval(babel, cache, resolve, promise, options, [name, ...stack])\n    );\n  });\n\n  const promise = Promise.all(promises).then(() => {});\n\n  mutexes.set(name, promise);\n\n  await promise;\n\n  mutexes.delete(name);\n\n  return Array.from(results);\n}\n"],"mappings":"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"}