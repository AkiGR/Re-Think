{"version":3,"file":"transform.js","names":["syncStages","originalCode","options","prepareStageResults","babelConfig","cache","eventEmitter","filename","every","r","withLinariaMetadata","metadata","code","sourceMap","inputSourceMap","type","evalStageResult","evalStage","map","valueCache","dependencies","collectStageResult","prepareForRuntime","babel","extractStageResult","extractStage","linaria","processors","replacements","transformSync","syncResolve","TransformCacheCollection","entryPoint","name","only","prepareForEvalSync","transform","asyncResolve","Promise","resolve","prepareForEval"],"sources":["../src/transform.ts"],"sourcesContent":["/**\n * This file exposes transform function that:\n * - parse the passed code to AST\n * - transforms the AST using Linaria babel preset ('./babel/index.js) and additional config defined in Linaria config file or passed to bundler configuration.\n * - runs generated CSS files through default of user-defined preprocessor\n * - generates source maps for CSS files\n * - return transformed code (without Linaria template literals), generated CSS, source maps and babel metadata from transform step.\n */\n\nimport type { TransformOptions } from '@babel/core';\nimport * as babel from '@babel/core';\n\nimport { TransformCacheCollection } from './cache';\nimport prepareForEval, {\n  prepareForEvalSync,\n} from './transform-stages/1-prepare-for-eval';\nimport evalStage from './transform-stages/2-eval';\nimport prepareForRuntime from './transform-stages/3-prepare-for-runtime';\nimport extractStage from './transform-stages/4-extract';\nimport type { Options, Result, ITransformFileResult } from './types';\nimport withLinariaMetadata from './utils/withLinariaMetadata';\n\nfunction syncStages(\n  originalCode: string,\n  options: Options,\n  prepareStageResults: ITransformFileResult[] | undefined,\n  babelConfig: TransformOptions,\n  cache: TransformCacheCollection,\n  eventEmitter?: (ev: unknown) => void\n) {\n  const { filename } = options;\n\n  // File does not contain any tags. Return original code.\n  if (\n    !prepareStageResults ||\n    prepareStageResults.every((r) => !withLinariaMetadata(r.metadata))\n  ) {\n    return {\n      code: originalCode,\n      sourceMap: options.inputSourceMap,\n    };\n  }\n\n  // *** 2nd stage ***\n\n  eventEmitter?.({ type: 'transform:stage-2:start', filename });\n\n  const evalStageResult = evalStage(\n    cache,\n    prepareStageResults.map((r) => r.code),\n    options\n  );\n\n  eventEmitter?.({ type: 'transform:stage-2:finish', filename });\n\n  if (evalStageResult === null) {\n    return {\n      code: originalCode,\n      sourceMap: options.inputSourceMap,\n    };\n  }\n\n  const [valueCache, dependencies] = evalStageResult;\n\n  // *** 3rd stage ***\n\n  eventEmitter?.({ type: 'transform:stage-3:start', filename });\n\n  const collectStageResult = prepareForRuntime(\n    babel,\n    originalCode,\n    valueCache,\n    options,\n    babelConfig\n  );\n\n  eventEmitter?.({ type: 'transform:stage-3:finish', filename });\n\n  if (!withLinariaMetadata(collectStageResult.metadata)) {\n    return {\n      code: collectStageResult.code!,\n      sourceMap: collectStageResult.map,\n    };\n  }\n\n  // *** 4th stage\n\n  eventEmitter?.({ type: 'transform:stage-4:start', filename });\n\n  const extractStageResult = extractStage(\n    collectStageResult.metadata.linaria.processors,\n    originalCode,\n    options\n  );\n\n  eventEmitter?.({ type: 'transform:stage-4:finish', filename });\n\n  return {\n    ...extractStageResult,\n    code: collectStageResult.code ?? '',\n    dependencies,\n    replacements: [\n      ...extractStageResult.replacements,\n      ...collectStageResult.metadata.linaria.replacements,\n    ],\n    sourceMap: collectStageResult.map,\n  };\n}\n\nexport function transformSync(\n  originalCode: string,\n  options: Options,\n  syncResolve: (what: string, importer: string, stack: string[]) => string,\n  babelConfig: TransformOptions = {},\n  cache = new TransformCacheCollection(),\n  eventEmitter?: (ev: unknown) => void\n): Result {\n  const { filename } = options;\n  // *** 1st stage ***\n\n  eventEmitter?.({ type: 'transform:stage-1:start', filename });\n\n  const entryPoint = {\n    name: options.filename,\n    code: originalCode,\n    only: ['__linariaPreval'],\n  };\n\n  const prepareStageResults = prepareForEvalSync(\n    babel,\n    cache,\n    syncResolve,\n    entryPoint,\n    options\n  );\n\n  eventEmitter?.({ type: 'transform:stage-1:finish', filename });\n\n  // *** The rest of the stages are synchronous ***\n\n  return syncStages(\n    originalCode,\n    options,\n    prepareStageResults,\n    babelConfig,\n    cache,\n    eventEmitter\n  );\n}\n\nexport default async function transform(\n  originalCode: string,\n  options: Options,\n  asyncResolve: (\n    what: string,\n    importer: string,\n    stack: string[]\n  ) => Promise<string | null>,\n  babelConfig: TransformOptions = {},\n  cache = new TransformCacheCollection(),\n  eventEmitter?: (ev: unknown) => void\n): Promise<Result> {\n  const { filename } = options;\n\n  // *** 1st stage ***\n\n  eventEmitter?.({ type: 'transform:stage-1:start', filename });\n\n  const entryPoint = Promise.resolve({\n    name: filename,\n    code: originalCode,\n    only: ['__linariaPreval'],\n  });\n\n  const prepareStageResults = await prepareForEval(\n    babel,\n    cache,\n    asyncResolve,\n    entryPoint,\n    options\n  );\n\n  eventEmitter?.({ type: 'transform:stage-1:finish', filename });\n\n  // *** The rest of the stages are synchronous ***\n\n  return syncStages(\n    originalCode,\n    options,\n    prepareStageResults,\n    babelConfig,\n    cache,\n    eventEmitter\n  );\n}\n"],"mappings":"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"}