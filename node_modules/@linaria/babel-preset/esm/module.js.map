{"version":3,"file":"module.js","names":["fs","NativeModule","path","vm","createCustomDebug","getFileIdx","TransformCacheCollection","process","builtins","assert","buffer","child_process","cluster","console","constants","crypto","dgram","dns","domain","events","http","https","module","net","os","punycode","querystring","readline","repl","stream","string_decoder","sys","timers","tls","tty","url","util","zlib","VALUES","Symbol","isProxy","obj","NOOP","padStart","num","len","toString","Module","isEvaluated","evaluatedFragments","Set","exports","lazyValues","tagProcessors","constructor","filename","options","cache","debuggerDepth","parentModule","idx","id","imports","paths","dependencies","transform","debug","resolveCache","codeCache","evalCache","Object","defineProperties","value","writable","freeze","_nodeModulePaths","dirname","Map","Proxy","get","target","key","values","forEach","v","k","has","ownKeys","Array","from","keys","set","undefined","defineProperty","descriptor","getOwnPropertyDescriptor","enumerable","configurable","extensions","resolve","resolveCacheKey","_extensions","added","ext","push","_resolveFilename","require","assign","resolved","onlyList","split","isAbsolute","Error","m","namespace","extension","extname","includes","code","perExportCache","only","filter","token","codeSet","every","o","add","readFileSync","test","length","JSON","parse","evaluate","ensure","arg","isArray","context","createContext","clearImmediate","clearInterval","clearTimeout","setImmediate","setInterval","setTimeout","global","__filename","__dirname","source","script","Script","runInContext","e","EvalError","callstack","message","join","invalidate","invalidateEvalCache"],"sources":["../src/module.ts"],"sourcesContent":["/**\n * This is a custom implementation for the module system for evaluating code,\n * used for resolving values for dependencies interpolated in `css` or `styled`.\n *\n * This serves 2 purposes:\n * - Avoid leakage from evaluated code to module cache in current context, e.g. `babel-register`\n * - Allow us to invalidate the module cache without affecting other stuff, necessary for rebuilds\n *\n * We also use it to transpile the code with Babel by default.\n * We also store source maps for it to provide correct error stacktraces.\n *\n */\n\nimport fs from 'fs';\nimport NativeModule from 'module';\nimport path from 'path';\nimport vm from 'vm';\n\nimport type { BabelFileResult } from '@babel/core';\n\nimport type { CustomDebug } from '@linaria/logger';\nimport { createCustomDebug } from '@linaria/logger';\nimport type { BaseProcessor } from '@linaria/tags';\nimport type { StrictOptions } from '@linaria/utils';\nimport { getFileIdx } from '@linaria/utils';\n\nimport { TransformCacheCollection } from './cache';\nimport * as process from './process';\nimport type { ITransformFileResult } from './types';\n\n// Supported node builtins based on the modules polyfilled by webpack\n// `true` means module is polyfilled, `false` means module is empty\nconst builtins = {\n  assert: true,\n  buffer: true,\n  child_process: false,\n  cluster: false,\n  console: true,\n  constants: true,\n  crypto: true,\n  dgram: false,\n  dns: false,\n  domain: true,\n  events: true,\n  fs: false,\n  http: true,\n  https: true,\n  module: false,\n  net: false,\n  os: true,\n  path: true,\n  punycode: true,\n  process: true,\n  querystring: true,\n  readline: false,\n  repl: false,\n  stream: true,\n  string_decoder: true,\n  sys: true,\n  timers: true,\n  tls: false,\n  tty: true,\n  url: true,\n  util: true,\n  vm: true,\n  zlib: true,\n};\n\nconst VALUES = Symbol('values');\n\nconst isProxy = (\n  obj: unknown\n): obj is { [VALUES]: Record<string | symbol, unknown> } =>\n  typeof obj === 'object' && obj !== null && VALUES in obj;\n\nconst NOOP = () => {};\n\nconst padStart = (num: number, len: number) =>\n  num.toString(10).padStart(len, '0');\n\nclass Module {\n  static invalidate: () => void;\n\n  static invalidateEvalCache: () => void;\n\n  static _resolveFilename: (\n    id: string,\n    options: { id: string; filename: string; paths: string[] }\n  ) => string;\n\n  static _nodeModulePaths: (filename: string) => string[];\n\n  #isEvaluated = false;\n\n  #evaluatedFragments = new Set<string>();\n\n  #exports: Record<string, unknown> | unknown;\n\n  // #exportsProxy: Record<string, unknown>;\n\n  #lazyValues: Map<string | symbol, () => unknown>;\n\n  readonly idx: number;\n\n  id: string;\n\n  filename: string;\n\n  options: StrictOptions;\n\n  imports: Map<string, string[]> | null;\n\n  paths: string[];\n\n  extensions: string[];\n\n  dependencies: string[] | null;\n\n  tagProcessors: BaseProcessor[] = [];\n\n  transform: ((text: string) => BabelFileResult | null) | null;\n\n  debug: CustomDebug;\n\n  resolveCache: Map<string, string>;\n\n  codeCache: Map<string, Map<string, ITransformFileResult>>;\n\n  evalCache: Map<string, Module>;\n\n  constructor(\n    filename: string,\n    options: StrictOptions,\n    cache = new TransformCacheCollection(),\n    private debuggerDepth = 0,\n    private parentModule?: Module\n  ) {\n    this.idx = getFileIdx(filename);\n    this.id = filename;\n    this.filename = filename;\n    this.options = options;\n    this.imports = null;\n    this.paths = [];\n    this.dependencies = null;\n    this.transform = null;\n    this.debug = createCustomDebug('module', this.idx);\n\n    this.resolveCache = cache.resolveCache;\n    this.codeCache = cache.codeCache;\n    this.evalCache = cache.evalCache;\n\n    Object.defineProperties(this, {\n      id: {\n        value: filename,\n        writable: false,\n      },\n      filename: {\n        value: filename,\n        writable: false,\n      },\n      paths: {\n        value: Object.freeze(\n          (\n            NativeModule as unknown as {\n              _nodeModulePaths(filename: string): string[];\n            }\n          )._nodeModulePaths(path.dirname(filename))\n        ),\n        writable: false,\n      },\n    });\n\n    this.#lazyValues = new Map();\n\n    const exports: Record<string | symbol, unknown> = {};\n\n    this.#exports = new Proxy(exports, {\n      get: (target, key) => {\n        if (key === VALUES) {\n          const values: Record<string | symbol, unknown> = {};\n          this.#lazyValues.forEach((v, k) => {\n            values[k] = v();\n          });\n\n          return values;\n        }\n        const value = this.#lazyValues.get(key)?.();\n        this.debug('evaluated', 'get %s: %o', key, value);\n        return value;\n      },\n      has: (target, key) => {\n        if (key === VALUES) return true;\n        return this.#lazyValues.has(key);\n      },\n      ownKeys: () => {\n        return Array.from(this.#lazyValues.keys());\n      },\n      set: (target, key, value) => {\n        if (value !== undefined) {\n          if (key !== '__esModule') {\n            this.debug('evaluated', 'set %s: %o', key, value);\n          }\n\n          this.#lazyValues.set(key, () => value);\n        }\n\n        return true;\n      },\n      defineProperty: (target, key, descriptor) => {\n        const { value } = descriptor;\n        if (value !== undefined) {\n          this.#lazyValues.set(key, () => value);\n\n          if (key !== '__esModule') {\n            this.debug(\n              'evaluated',\n              'defineProperty %s with value %o',\n              key,\n              value\n            );\n          }\n\n          this.#lazyValues.set(key, () => value);\n\n          return true;\n        }\n\n        if ('get' in descriptor) {\n          this.#lazyValues.set(key, descriptor.get!);\n          this.debug('evaluated', 'defineProperty %s with getter', key);\n        }\n\n        return true;\n      },\n      getOwnPropertyDescriptor: (target, key) => {\n        if (this.#lazyValues.has(key))\n          return {\n            enumerable: true,\n            configurable: true,\n          };\n\n        return undefined;\n      },\n    });\n\n    this.extensions = options.extensions;\n    this.debug('init', filename);\n  }\n\n  public get exports() {\n    return this.#exports;\n  }\n\n  public set exports(value) {\n    if (isProxy(value)) {\n      this.#exports = value[VALUES];\n    } else {\n      this.#exports = value;\n    }\n\n    this.debug(\n      'evaluated',\n      'the whole exports was overridden with %O',\n      this.#exports\n    );\n  }\n\n  resolve = (id: string) => {\n    const resolveCacheKey = `${this.filename} -> ${id}`;\n    if (this.resolveCache.has(resolveCacheKey)) {\n      return this.resolveCache.get(resolveCacheKey)!;\n    }\n\n    const extensions = (\n      NativeModule as unknown as {\n        _extensions: { [key: string]: () => void };\n      }\n    )._extensions;\n    const added: string[] = [];\n\n    try {\n      // Check for supported extensions\n      this.extensions.forEach((ext) => {\n        if (ext in extensions) {\n          return;\n        }\n\n        // When an extension is not supported, add it\n        // And keep track of it to clean it up after resolving\n        // Use noop for the transform function since we handle it\n        extensions[ext] = NOOP;\n        added.push(ext);\n      });\n\n      return Module._resolveFilename(id, this);\n    } finally {\n      // Cleanup the extensions we added to restore previous behaviour\n      added.forEach((ext) => delete extensions[ext]);\n    }\n  };\n\n  require: {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    (id: string): any;\n    resolve: (id: string) => string;\n    ensure: () => void;\n  } = Object.assign(\n    (id: string) => {\n      if (id in builtins) {\n        // The module is in the allowed list of builtin node modules\n        // Ideally we should prevent importing them, but webpack polyfills some\n        // So we check for the list of polyfills to determine which ones to support\n        if (builtins[id as keyof typeof builtins]) {\n          this.debug('require', `builtin '${id}'`);\n          return require(id);\n        }\n\n        return null;\n      }\n\n      // Resolve module id (and filename) relatively to parent module\n      const resolved = this.resolve(id);\n      const [filename, onlyList] = resolved.split('\\0');\n      if (filename === id && !path.isAbsolute(id)) {\n        // The module is a builtin node modules, but not in the allowed list\n        throw new Error(\n          `Unable to import \"${id}\". Importing Node builtins is not supported in the sandbox.`\n        );\n      }\n\n      this.dependencies?.push(id);\n\n      let m: Module;\n\n      this.debug('require', `${id} -> ${filename}`);\n\n      if (this.evalCache.has(filename)) {\n        m = this.evalCache.get(filename)!;\n        this.debug('eval-cache', '✅ %r has been gotten from cache', {\n          namespace: `module:${padStart(m.idx, 5)}`,\n        });\n      } else {\n        this.debug('eval-cache', `❌ %r is going to be initialized`, {\n          namespace: `module:${padStart(getFileIdx(filename), 5)}`,\n        });\n        // Create the module if cached module is not available\n        m = new Module(\n          filename,\n          this.options,\n          {\n            codeCache: this.codeCache,\n            evalCache: this.evalCache,\n            resolveCache: this.resolveCache,\n          },\n          this.debuggerDepth + 1,\n          this\n        );\n        m.transform = this.transform;\n\n        // Store it in cache at this point with, otherwise\n        // we would end up in infinite loop with cyclic dependencies\n        this.evalCache.set(filename, m);\n      }\n\n      const extension = path.extname(filename);\n      if (extension === '.json' || this.extensions.includes(extension)) {\n        let code: string[] | undefined;\n        // Requested file can be already prepared for evaluation on the stage 1\n        if (this.codeCache.has(filename)) {\n          const perExportCache = this.codeCache.get(filename)!;\n          const only = onlyList\n            ?.split(',')\n            .filter((token) => !m.#lazyValues.has(token));\n          const codeSet = new Set<string>();\n          if (only && only.every((o) => perExportCache.has(o))) {\n            m.debug('code-cache', '✅');\n            only.forEach((o) => codeSet.add(perExportCache.get(o)!.code));\n          } else if (!only && perExportCache.has('*')) {\n            m.debug('code-cache', '✳️');\n            // The whole file is required\n            codeSet.add(perExportCache.get('*')!.code);\n          }\n\n          code = Array.from(codeSet);\n        } else if (m.#isEvaluated) {\n          m.debug(\n            'code-cache',\n            '✅ not in the code cache, but is already evaluated'\n          );\n          code = [];\n        }\n\n        if (!code) {\n          // If code wasn't extracted from cache, read it from the file system\n          // TODO: transpile the file\n          m.debug('code-cache', '❌');\n          code = [fs.readFileSync(filename, 'utf-8')];\n        }\n\n        if (/\\.json$/.test(filename) && code.length === 1) {\n          // For JSON files, parse it to a JS object similar to Node\n          m.exports = JSON.parse(code[0]);\n          m.#isEvaluated = true;\n        } else {\n          // For JS/TS files, evaluate the module\n          m.evaluate(code);\n        }\n      } else {\n        // For non JS/JSON requires, just export the id\n        // This is to support importing assets in webpack\n        // The module will be resolved by css-loader\n        m.exports = filename;\n        m.#isEvaluated = true;\n      }\n\n      return m.exports;\n    },\n    {\n      ensure: NOOP,\n      resolve: this.resolve,\n    }\n  );\n\n  evaluate(arg: string | string[]): void {\n    const code = Array.isArray(arg) ? arg : [arg];\n    const { filename } = this;\n\n    if (code.length === 0) {\n      this.debug(`evaluate`, 'there is nothing to evaluate');\n    }\n\n    const context = vm.createContext({\n      clearImmediate: NOOP,\n      clearInterval: NOOP,\n      clearTimeout: NOOP,\n      setImmediate: NOOP,\n      setInterval: NOOP,\n      setTimeout: NOOP,\n      global,\n      process,\n      module: this,\n      exports: this.#exports,\n      require: this.require,\n      __filename: filename,\n      __dirname: path.dirname(filename),\n    });\n\n    code.forEach((source, idx) => {\n      if (this.#evaluatedFragments.has(source)) {\n        this.debug(\n          `evaluate:fragment-${padStart(idx + 1, 2)}`,\n          `is already evaluated`\n        );\n        return;\n      }\n\n      this.debug(`evaluate:fragment-${padStart(idx + 1, 2)}`, `\\n${source}`);\n\n      this.#evaluatedFragments.add(source);\n\n      this.#isEvaluated = true;\n\n      try {\n        const script = new vm.Script(\n          `(function (exports) { ${source}\\n})(exports);`,\n          {\n            filename,\n          }\n        );\n\n        script.runInContext(context);\n        return;\n      } catch (e) {\n        if (e instanceof EvalError) {\n          throw e;\n        }\n\n        const callstack: string[] = ['', this.filename];\n        let module = this.parentModule;\n        while (module) {\n          callstack.push(module.filename);\n          module = module.parentModule;\n        }\n\n        this.debug('evaluate:error', '%O\\n%O', e, callstack);\n        throw new EvalError(\n          `${(e as Error).message} in${callstack.join('\\n| ')}\\n`\n        );\n      }\n    });\n  }\n}\n\nModule.invalidate = () => {};\n\nModule.invalidateEvalCache = () => {};\n\n// Alias to resolve the module using node's resolve algorithm\n// This static property can be overriden by the webpack loader\n// This allows us to use webpack's module resolution algorithm\nModule._resolveFilename = (id, options) =>\n  (\n    NativeModule as unknown as {\n      _resolveFilename: typeof Module._resolveFilename;\n    }\n  )._resolveFilename(id, options);\n\nModule._nodeModulePaths = (filename: string) =>\n  (\n    NativeModule as unknown as {\n      _nodeModulePaths: (filename: string) => string[];\n    }\n  )._nodeModulePaths(filename);\n\nexport default Module;\n"],"mappings":"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"}